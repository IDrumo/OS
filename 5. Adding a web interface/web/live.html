<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .current-reading {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-top: 20px;
        }
        .current-temp {
            font-size: 48px;
            font-weight: bold;
        }
        .current-time {
            font-size: 14px;
            opacity: 0.9;
        }
        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h1>
        <p>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
    </div>

    <div class="status">
        <div class="stat-item">
            <div class="stat-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div>
            <div class="stat-value"><span class="live-indicator"></span> –í —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
            <div class="stat-value" id="update-frequency">5 —Å–µ–∫</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">–¢–æ—á–µ–∫ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ</div>
            <div class="stat-value" id="point-count">0</div>
        </div>
    </div>

    <div class="controls">
        <button onclick="startLiveUpdates()" id="start-btn">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
        <button onclick="stopLiveUpdates()" id="stop-btn" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
        <button onclick="clearChart()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
        <button onclick="changeUpdateInterval(1)">1 —Å–µ–∫</button>
        <button onclick="changeUpdateInterval(5)">5 —Å–µ–∫</button>
        <button onclick="changeUpdateInterval(10)">10 —Å–µ–∫</button>
        <button onclick="window.location.href='/index.html'">üìä –ö –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–º—É –≥—Ä–∞—Ñ–∏–∫—É</button>
    </div>

    <div class="chart-container">
        <canvas id="liveChart"></canvas>
    </div>

    <div class="current-reading">
        <h3>–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</h3>
        <div class="current-temp" id="current-temp">-- ¬∞C</div>
        <div class="current-time" id="current-time">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
</div>

<script>
    let liveChart = null;
    let updateInterval = null;
    let updateFrequency = 5000; // 5 —Å–µ–∫—É–Ω–¥
    let lastUpdateTime = null;
    let isUpdating = false;
    let maxDataPoints = 100; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function formatTime(date) {
        return date.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function formatDateTimeForApi(date) {
        return date.toISOString().slice(0, 19) + 'Z';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    function initChart() {
        const ctx = document.getElementById('liveChart').getContext('2d');
        liveChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 3,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0 // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                },
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            text: '–í—Ä–µ–º—è'
                        },
                        ticks: {
                            callback: function(value) {
                                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º timestamp –≤ —á–∏—Ç–∞–µ–º–æ–µ –≤—Ä–µ–º—è
                                const date = new Date(value * 1000);
                                return formatTime(date);
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)'
                        },
                        suggestedMin: 15,
                        suggestedMax: 35
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${context.parsed.y.toFixed(2)}¬∞C`;
                            },
                            title: function(tooltipItems) {
                                const timestamp = tooltipItems[0].parsed.x;
                                const date = new Date(timestamp * 1000);
                                return date.toLocaleString('ru-RU');
                            }
                        }
                    }
                }
            }
        });
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫
    function addDataPoint(timestamp, temperature) {
        if (!liveChart) return;

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        liveChart.data.labels.push(timestamp);
        liveChart.data.datasets[0].data.push(temperature);

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫
        if (liveChart.data.labels.length > maxDataPoints) {
            liveChart.data.labels.shift();
            liveChart.data.datasets[0].data.shift();
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
        liveChart.update('none');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ç–æ—á–µ–∫
        document.getElementById('point-count').textContent = liveChart.data.labels.length;
    }

    // –ó–∞–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function fetchLiveUpdates() {
        try {
            const url = lastUpdateTime
                ? `/api/live?since=${encodeURIComponent(formatDateTimeForApi(lastUpdateTime))}`
                : '/api/live';

            const response = await fetch(url);
            if (!response.ok) throw new Error('Network error');

            const data = await response.json();

            if (data.data && data.data.length > 0) {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç–æ—á–∫–∏
                data.data.forEach(measurement => {
                    const timestamp = new Date(measurement.timestamp);
                    addDataPoint(timestamp.getTime() / 1000, measurement.temperature);
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è
                if (data.lastUpdate) {
                    lastUpdateTime = new Date(data.lastUpdate);

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    const latest = data.data[data.data.length - 1];
                    document.getElementById('current-temp').textContent =
                        `${latest.temperature.toFixed(2)} ¬∞C`;
                    document.getElementById('current-time').textContent =
                        `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(latest.timestamp).toLocaleString('ru-RU')}`;
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
            if (error.message !== 'Network error') {
                stopLiveUpdates();
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }
    }

    // –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    function startLiveUpdates() {
        if (isUpdating) return;

        isUpdating = true;
        document.getElementById('start-btn').disabled = true;
        document.getElementById('stop-btn').disabled = false;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        fetchLiveUpdates();

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        updateInterval = setInterval(fetchLiveUpdates, updateFrequency);

        console.log('Live updates started with interval:', updateFrequency, 'ms');
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    function stopLiveUpdates() {
        if (!isUpdating) return;

        isUpdating = false;
        document.getElementById('start-btn').disabled = false;
        document.getElementById('stop-btn').disabled = true;

        if (updateInterval) {
            clearInterval(updateInterval);
            updateInterval = null;
        }

        console.log('Live updates stopped');
    }

    // –û—á–∏—Å—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    function clearChart() {
        if (liveChart) {
            liveChart.data.labels = [];
            liveChart.data.datasets[0].data = [];
            liveChart.update();
            document.getElementById('point-count').textContent = '0';
            lastUpdateTime = null;
        }
    }

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    function changeUpdateInterval(seconds) {
        updateFrequency = seconds * 1000;
        document.getElementById('update-frequency').textContent = seconds + ' —Å–µ–∫';

        // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—â–µ–Ω—ã, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–æ–≤—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
        if (isUpdating) {
            stopLiveUpdates();
            startLiveUpdates();
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('DOMContentLoaded', function() {
        initChart();
        startLiveUpdates();

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(startLiveUpdates, 1000);
    });

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        stopLiveUpdates();
    });
</script>
</body>
</html>