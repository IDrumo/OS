<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ */
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .controls { margin-bottom: 20px; }
        .controls input { margin: 0 10px; padding: 5px; }
        .controls button { padding: 5px 15px; margin: 0 5px; }
        .chart-container { width: 100%; height: 400px; margin: 20px 0; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat-card { flex: 1; padding: 15px; background: #f0f0f0; border-radius: 5px; }

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .nav-link {
            padding: 10px 20px;
            text-decoration: none;
            color: #007bff;
            border: 2px solid #007bff;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .nav-link:hover {
            background: #007bff;
            color: white;
        }
        .nav-link.active {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="nav-bar">
        <a href="index.html" class="nav-link active">üìä –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ–∏–∫</a>
        <a href="live.html" class="nav-link">‚ö° –ì—Ä–∞—Ñ–∏–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</a>
    </div>

    <div class="header">
        <h1>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä</h1>
        <p>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ</p>
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <div class="controls">
        <label>–°: <input type="datetime-local" id="from"></label>
        <label>–ü–æ: <input type="datetime-local" id="to"></label>
        <button onclick="loadData()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button onclick="loadLastHour()">–ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å</button>
        <button onclick="loadLastDay()">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏</button>
        <button onclick="loadLastWeek()">–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è</button>
    </div>

    <div class="stats" id="stats">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
    </div>

    <div class="chart-container">
        <canvas id="temperatureChart"></canvas>
    </div>

    <div style="margin-top: 20px; padding: 15px; background: #f9f9f9;">
        <h3>–¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</h3>
        <div id="current-data">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
</div>

<script>
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π JavaScript –∫–æ–¥
    let temperatureChart = null;
    let autoUpdateInterval = null;

    function formatDateTimeLocal(d) {
        return d.toISOString().slice(0, 16);
    }

    function formatDateTimeForApi(d) {
        return d.toISOString().slice(0, 19) + 'Z';
    }

    function setDefaultTimeRange() {
        const to = new Date();
        const from = new Date(to.getTime() - 24 * 60 * 60 * 1000);

        document.getElementById('from').value = formatDateTimeLocal(from);
        document.getElementById('to').value = formatDateTimeLocal(to);
    }

    async function fetchCurrentData() {
        try {
            const response = await fetch('/api/current');
            if (!response.ok) throw new Error('Network error');

            const data = await response.json();

            if (data.data && data.data.length > 0) {
                const latest = data.data[0];
                const currentDiv = document.getElementById('current-data');
                const time = new Date(latest.timestamp);

                currentDiv.innerHTML = `
                        <p><strong>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</strong> ${latest.temperature.toFixed(2)} ¬∞C</p>
                        <p><strong>–í—Ä–µ–º—è:</strong> ${time.toLocaleString('ru-RU')}</p>
                    `;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
            document.getElementById('current-data').innerHTML =
                '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
        }
    }

    async function loadChartData(from, to) {
        try {
            const fromStr = encodeURIComponent(formatDateTimeForApi(from));
            const toStr = encodeURIComponent(formatDateTimeForApi(to));

            const response = await fetch(`/api/range?from=${fromStr}&to=${toStr}`);
            if (!response.ok) throw new Error('Network error');

            const data = await response.json();

            if (!data.data || data.data.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥');
                return;
            }

            const timestamps = data.data.map(m => new Date(m.timestamp));
            const temperatures = data.data.map(m => m.temperature);

            if (!temperatureChart) {
                const ctx = document.getElementById('temperatureChart').getContext('2d');
                temperatureChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timestamps,
                        datasets: [{
                            label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',
                            data: temperatures,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 2,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    displayFormats: {
                                        hour: 'dd.MM HH:mm'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: '–í—Ä–µ–º—è'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '¬∞C';
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                temperatureChart.data.labels = timestamps;
                temperatureChart.data.datasets[0].data = temperatures;
                temperatureChart.update();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
        }
    }

    async function loadStatistics(from, to) {
        try {
            const fromStr = encodeURIComponent(formatDateTimeForApi(from));
            const toStr = encodeURIComponent(formatDateTimeForApi(to));

            const response = await fetch(`/api/stats?from=${fromStr}&to=${toStr}`);
            if (!response.ok) throw new Error('Network error');

            const stats = await response.json();

            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `
                    <div class="stat-card">
                        <h4>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π</h4>
                        <div>${stats.count}</div>
                    </div>
                    <div class="stat-card">
                        <h4>–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</h4>
                        <div>${stats.average.toFixed(2)}¬∞C</div>
                    </div>
                    <div class="stat-card">
                        <h4>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è</h4>
                        <div>${stats.max.toFixed(2)}¬∞C</div>
                    </div>
                    <div class="stat-card">
                        <h4>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è</h4>
                        <div>${stats.min.toFixed(2)}¬∞C</div>
                    </div>
                `;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        }
    }

    async function loadData() {
        const fromInput = document.getElementById('from').value;
        const toInput = document.getElementById('to').value;

        if (!fromInput || !toInput) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥');
            return;
        }

        const from = new Date(fromInput);
        const to = new Date(toInput);

        if (from >= to) {
            alert('–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π');
            return;
        }

        await loadChartData(from, to);
        await loadStatistics(from, to);
    }

    function loadLastHour() {
        const to = new Date();
        const from = new Date(to.getTime() - 60 * 60 * 1000);
        document.getElementById('from').value = formatDateTimeLocal(from);
        document.getElementById('to').value = formatDateTimeLocal(to);
        loadData();
    }

    function loadLastDay() {
        const to = new Date();
        const from = new Date(to.getTime() - 24 * 60 * 60 * 1000);
        document.getElementById('from').value = formatDateTimeLocal(from);
        document.getElementById('to').value = formatDateTimeLocal(to);
        loadData();
    }

    function loadLastWeek() {
        const to = new Date();
        const from = new Date(to.getTime() - 7 * 24 * 60 * 60 * 1000);
        document.getElementById('from').value = formatDateTimeLocal(from);
        document.getElementById('to').value = formatDateTimeLocal(to);
        loadData();
    }

    function startAutoUpdate() {
        autoUpdateInterval = setInterval(fetchCurrentData, 10000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('DOMContentLoaded', function() {
        setDefaultTimeRange();
        loadData();
        fetchCurrentData();
        startAutoUpdate();
    });

    // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        if (autoUpdateInterval) {
            clearInterval(autoUpdateInterval);
        }
    });
</script>
</body>
</html>