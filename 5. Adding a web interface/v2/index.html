<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Температурный монитор</title>
    <!-- Chart.js с адаптером для дат -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: Arial; margin: 20px; }
        .chart-container { width: 800px; height: 400px; margin: 20px 0; }
        .controls { margin: 20px 0; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat-card { padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .error { color: red; padding: 10px; background: #ffe6e6; border-radius: 5px; }
        .interval-buttons button {
            margin-right: 5px;
            padding: 5px 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .interval-buttons button:hover {
            background: #45a049;
        }
        .time-info {
            margin: 10px 0;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 3px;
            font-size: 14px;
        }
        #realtimeBtn.active { background: #ff4444; }
        #autoUpdateBtn.active { background: #ff4444; }
    </style>
</head>
<body>
<h1>Температурный монитор</h1>

<div class="time-info">
    <strong>Текущее время (UTC):</strong> <span id="serverTime"></span> |
    <strong>Ваше время:</strong> <span id="localTime"></span>
</div>

<div class="controls">
    <label>С: <input type="datetime-local" id="from"></label>
    <label>По: <input type="datetime-local" id="to"></label>

    <div style="margin: 10px 0;">
        <button onclick="loadData()">Загрузить</button>
        <div class="interval-buttons">
            <button onclick="setIntervalHours(1)">1 час</button>
            <button onclick="setIntervalHours(24)">24 часа</button>
        </div>
        <button onclick="toggleRealtime()" id="realtimeBtn">Реальное время</button>
        <button onclick="toggleAutoUpdate()" id="autoUpdateBtn">Автообновление</button>
    </div>
</div>

<div class="chart-container">
    <canvas id="chart"></canvas>
</div>

<div class="stats" id="stats">
    <div class="stat-card">Измерений: 0</div>
    <div class="stat-card">Средняя: 0°C</div>
    <div class="stat-card">Мин: 0°C</div>
    <div class="stat-card">Макс: 0°C</div>
</div>

<div id="error" class="error" style="display: none;"></div>

<script>
    // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
    let chart = null;
    let updateInterval = null;
    let isRealtime = false;
    let lastDataTime = 0;

    // ========== ФУНКЦИИ ФОРМАТИРОВАНИЯ ==========
    function formatLocal(d) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function formatUTC(d) {
        const year = d.getUTCFullYear();
        const month = String(d.getUTCMonth() + 1).padStart(2, '0');
        const day = String(d.getUTCDate()).padStart(2, '0');
        const hours = String(d.getUTCHours()).padStart(2, '0');
        const minutes = String(d.getUTCMinutes()).padStart(2, '0');
        const seconds = String(d.getUTCSeconds()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}Z`;
    }

    // ========== УСТАНОВКА ИНТЕРВАЛОВ ==========
    function setIntervalHours(hours) {
        stopUpdates();
        const now = new Date();
        const from = new Date(now.getTime() - hours * 3600000);
        document.getElementById('from').value = formatLocal(from);
        document.getElementById('to').value = formatLocal(now);
        loadData();
    }

    // ========== УПРАВЛЕНИЕ ОБНОВЛЕНИЯМИ ==========
    function stopUpdates() {
        if (updateInterval) {
            clearInterval(updateInterval);
            updateInterval = null;
        }
        isRealtime = false;
        document.getElementById('realtimeBtn').classList.remove('active');
        document.getElementById('autoUpdateBtn').classList.remove('active');
    }

    function toggleRealtime() {
        const btn = document.getElementById('realtimeBtn');

        if (isRealtime) {
            stopUpdates();
            btn.textContent = 'Реальное время';
        } else {
            // Останавливаем автообновление если активно
            if (updateInterval) stopUpdates();

            // Устанавливаем интервал 5 минут
            const to = new Date();
            const from = new Date(to.getTime() - 5 * 60 * 1000);
            document.getElementById('from').value = formatLocal(from);
            document.getElementById('to').value = formatLocal(to);

            isRealtime = true;
            btn.classList.add('active');
            btn.textContent = 'Остановить';

            // Загружаем сразу и каждую секунду
            loadData();
            updateInterval = setInterval(loadData, 2000);
        }
    }

    function toggleAutoUpdate() {
        const btn = document.getElementById('autoUpdateBtn');

        if (updateInterval && !isRealtime) {
            stopUpdates();
            btn.textContent = 'Автообновление';
        } else {
            // Останавливаем реальное время если активно
            if (isRealtime) stopUpdates();

            btn.classList.add('active');
            btn.textContent = 'Остановить';

            // Функция для сдвига окна
            function slideWindow() {
                const from = new Date(document.getElementById('from').value);
                const to = new Date(document.getElementById('to').value);
                const diff = to - from;

                const newTo = new Date();
                const newFrom = new Date(newTo.getTime() - diff);

                document.getElementById('from').value = formatLocal(newFrom);
                document.getElementById('to').value = formatLocal(newTo);
                loadData();
            }

            // Запускаем каждые 5 секунд
            slideWindow();
            updateInterval = setInterval(slideWindow, 5000);
        }
    }

    // ========== ЗАГРУЗКА ДАННЫХ ==========
    async function loadData() {
        const from = document.getElementById('from').value;
        const to = document.getElementById('to').value;

        if (!from || !to) {
            showError("Укажите диапазон дат!");
            return;
        }

        // Проверка дат
        const fromDate = new Date(from);
        const toDate = new Date(to);

        if (fromDate >= toDate) {
            showError("Дата 'С' должна быть раньше даты 'По'!");
            return;
        }

        // Формируем URL
        const fromStr = formatUTC(fromDate);
        const toStr = formatUTC(toDate);
        const url = `/api/range?from=${encodeURIComponent(fromStr)}&to=${encodeURIComponent(toStr)}`;

        try {
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP ошибка: ${response.status}`);
            }

            const data = await response.json();

            if (data.data && data.data.length > 0) {
                const values = data.data.map(d => d.v);
                const dates = data.data.map(d => new Date(d.t));

                // Обновляем статистику
                const stats = {
                    count: values.length,
                    avg: values.reduce((a, b) => a + b, 0) / values.length,
                    min: Math.min(...values),
                    max: Math.max(...values)
                };

                document.getElementById('stats').innerHTML = `
                <div class="stat-card">Измерений: ${stats.count}</div>
                <div class="stat-card">Средняя: ${stats.avg.toFixed(2)}°C</div>
                <div class="stat-card">Мин: ${stats.min.toFixed(2)}°C</div>
                <div class="stat-card">Макс: ${stats.max.toFixed(2)}°C</div>
            `;

                // Обновляем график
                updateChart(dates, values);

                // Запоминаем время последних данных
                lastDataTime = Date.now();
            }
        } catch (error) {
            console.error('Ошибка загрузки:', error);
            if (!isRealtime) {
                showError('Ошибка загрузки: ' + error.message);
            }
        }
    }

    // ========== АГРЕГАЦИЯ ДАННЫХ ==========
    function aggregateData(dates, values, maxPoints = 10) {
        if (dates.length <= maxPoints) {
            return { dates, values };
        }

        // Определяем интервал агрегации на основе количества точек
        const interval = Math.ceil(dates.length / maxPoints);
        const aggregatedDates = [];
        const aggregatedValues = [];

        for (let i = 0; i < dates.length; i += interval) {
            const chunkDates = dates.slice(i, i + interval);
            const chunkValues = values.slice(i, i + interval);

            if (chunkDates.length > 0) {
                // Берем среднее время в чанке
                const avgTime = new Date(
                    chunkDates.reduce((sum, date) => sum + date.getTime(), 0) / chunkDates.length
                );

                // Берем среднее значение в чанке
                const avgValue = chunkValues.reduce((sum, val) => sum + val, 0) / chunkValues.length;

                aggregatedDates.push(avgTime);
                aggregatedValues.push(avgValue);
            }
        }

        return { dates: aggregatedDates, values: aggregatedValues };
    }

    // ========== ОБНОВЛЕНИЕ ГРАФИКА ==========
    function updateChart(labels, data) {
        const ctx = document.getElementById('chart').getContext('2d');

        // Агрегируем данные если их слишком много
        const aggregated = aggregateData(labels, data);
        const displayLabels = aggregated.dates;
        const displayData = aggregated.values;

        if (!chart) {
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayLabels,
                    datasets: [{
                        label: 'Температура (°C)',
                        data: displayData,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    minute: 'HH:mm',
                                    hour: 'HH:mm'
                                }
                            },
                            title: { display: true, text: 'Время' }
                        },
                        y: {
                            title: { display: true, text: 'Температура (°C)' }
                        }
                    }
                }
            });
        } else {
            chart.data.labels = displayLabels;
            chart.data.datasets[0].data = displayData;
            chart.update();
        }
    }

    // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
    function showError(message) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => errorDiv.style.display = 'none', 3000);
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('localTime').textContent = now.toLocaleTimeString('ru-RU');
        document.getElementById('serverTime').textContent = now.toUTCString().replace('GMT', 'UTC');
    }

    // ========== ИНИЦИАЛИЗАЦИЯ ==========
    window.onload = function() {
        // Запускаем часы
        setInterval(updateClock, 1000);
        updateClock();

        // Устанавливаем начальный диапазон (24 часа)
        setIntervalHours(24);
    };
</script>
</body>
</html>